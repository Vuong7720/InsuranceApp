@page "/admin/users"
@using InsuranceApp.Web.Models
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using Microsoft.FluentUI.AspNetCore.Components
@inject UserManager<IdentityUser> UserManager
@inject IDialogService DialogService
@inject IMessageService MessageService
@rendermode InteractiveServer

<FluentHeader Style="background-color: transparent; color: var(--neutral-foreground-rest); padding: 0;">
    <FluentStack Orientation="Orientation.Horizontal" VerticalAlignment="VerticalAlignment.Center">
        <FluentIcon Value="@(new Icons.Regular.Size24.PeopleSettings())" Color="@Color.Accent" />
        <FluentLabel Typo="Typography.H3">Quản lý tài khoản nhân viên</FluentLabel>
        <FluentSpacer />
        <FluentButton Appearance="Appearance.Accent" IconStart="@(new Icons.Regular.Size20.Add())" OnClick="@OpenCreateUserDialog">
            Thêm nhân viên mới
        </FluentButton>
    </FluentStack>
</FluentHeader>

<FluentDivider Style="margin: 15px 0;" />

@if (userList == null)
{
    <FluentProgressRing>Đang tải dữ liệu...</FluentProgressRing>
}
else
{
    <div class="grid" style="width: 100%; overflow: auto;">
        <FluentDataGrid Items="@userList" ResizableColumns="true" Pagination="@pagination">
            <PropertyColumn Property="@(u => u.Email)" Title="Email" Sortable="true" Filtered="true" />
            <PropertyColumn Property="@(u => u.UserName)" Title="Tên đăng nhập" />

            <TemplateColumn Title="Thao tác" Align="Align.Center">
                <FluentButton Appearance="Appearance.Stealth"
                              IconEnd="@(new Icons.Regular.Size20.Delete())"
                              Color="Color.Error"
                              OnClick="@(() => ConfirmDelete(context))" />
            </TemplateColumn>
        </FluentDataGrid>
    </div>

    <FluentPaginator State="@pagination" />
}

@code {
    private IQueryable<IdentityUser>? userList;
    PaginationState pagination = new PaginationState { ItemsPerPage = 10 };

    protected override async Task OnInitializedAsync()
    {
        await LoadUsers();
    }

    private async Task LoadUsers()
    {
        // Lấy lại danh sách từ Database
        var users = await UserManager.Users.ToListAsync();
        userList = users.AsQueryable();
    }

    private async Task OpenCreateUserDialog()
    {
        var data = new CreateUserModel();

        var dialog = await DialogService.ShowDialogAsync<CreateUserDialog>(data, new DialogParameters
        {
            Title = "Thêm nhân viên",
            PrimaryAction = null, // Ẩn nút mặc định để dùng nút trong Component
            SecondaryAction = null,
            Width = "400px",
            TrapFocus = true,
            Modal = true
        });

        var result = await dialog.Result;

        if (!result.Cancelled)
        {
            // Khi lưu thành công, Dialog trả về data
            // QUAN TRỌNG: Gọi lại hàm load dữ liệu để UI cập nhật ngay lập tức
            await LoadUsers();

            // Hiện thông báo nhỏ góc màn hình (Toast)
            // ToastService.ShowSuccess("Đã thêm nhân viên thành công!");
        }
    }

    private async Task ConfirmDelete(IdentityUser user)
    {
        var dialog = await DialogService.ShowConfirmationAsync(
            $"Bạn có chắc chắn muốn xóa tài khoản {user.Email}?",
            "Xác nhận xóa",
            "Xóa ngay",
            "Hủy");

        var result = await dialog.Result;

        if (!result.Cancelled)
        {
            var deleteResult = await UserManager.DeleteAsync(user);
            if (deleteResult.Succeeded)
            {
                // QUAN TRỌNG: Tải lại danh sách ngay lập tức để UI cập nhật
                await LoadUsers();
                await MessageService.ShowMessageBarAsync(options =>
                {
                    options.Title = "Thành công";
                    options.Body = "Đã xóa nhân viên.";
                    options.Intent = MessageIntent.Success;
                });
            }
        }
    }
}